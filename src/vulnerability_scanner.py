import json
import re
from datetime import datetime
from typing import Dict, List, Any
from enum import Enum
import logging

logger = logging.getLogger(__name__)

class VulnerabilityType(Enum):
    """Types of vulnerabilities"""
    CRITICAL = "CRITICAL"
    HIGH = "HIGH"
    MEDIUM = "MEDIUM"
    LOW = "LOW"
    INFO = "INFO"

class VulnerabilityScanner:
    """Continuous vulnerability detection and assessment"""
    
    def __init__(self):
        self.vulnerability_db = self._initialize_vuln_db()
        self.scanned_assets = []
        self.found_vulnerabilities = []
        
    def _initialize_vuln_db(self) -> Dict:
        """Initialize vulnerability database with common CVEs"""
        return {
            'CVE-2024-1234': {
                'type': VulnerabilityType.CRITICAL,
                'description': 'Remote Code Execution in Web Framework',
                'cvss_score': 9.8
            },
            'CVE-2024-5678': {
                'type': VulnerabilityType.HIGH,
                'description': 'SQL Injection in Database Module',
                'cvss_score': 8.6
            },
            'CVE-2024-9101': {
                'type': VulnerabilityType.MEDIUM,
                'description': 'Cross-Site Scripting (XSS) in UI',
                'cvss_score': 6.1
            },
            'CVE-2024-1121': {
                'type': VulnerabilityType.HIGH,
                'description': 'Authentication Bypass in API Gateway',
                'cvss_score': 7.9
            }
        }
    
    def scan_asset(self, asset_info: Dict[str, Any]) -> Dict[str, Any]:
        """Scan an asset for known vulnerabilities"""
        scan_result = {
            'asset_id': asset_info.get('id'),
            'asset_type': asset_info.get('type'),
            'scan_timestamp': datetime.now().isoformat(),
            'vulnerabilities_found': [],
            'risk_score': 0.0,
            'status': 'COMPLETED'
        }
        
        # Check asset software versions against CVEs
        for cve_id, vuln_data in self.vulnerability_db.items():
            if self._is_asset_vulnerable(asset_info, cve_id):
                vuln_entry = {
                    'cve_id': cve_id,
                    'type': vuln_data['type'].value,
                    'description': vuln_data['description'],
                    'cvss_score': vuln_data['cvss_score'],
                    'severity': self._calculate_severity(vuln_data['cvss_score']),
                    'status': 'UNPATCHED'
                }
                scan_result['vulnerabilities_found'].append(vuln_entry)
        
        # Calculate overall risk score
        scan_result['risk_score'] = self._calculate_risk_score(scan_result['vulnerabilities_found'])
        
        self.scanned_assets.append(asset_info)
        self.found_vulnerabilities.extend(scan_result['vulnerabilities_found'])
        
        return scan_result
    
    def _is_asset_vulnerable(self, asset: Dict, cve_id: str) -> bool:
        """Check if asset is vulnerable to specific CVE"""
        software_version = asset.get('software_version', '')
        software_name = asset.get('software_name', '')
        
        # Simplified vulnerability check logic
        vulnerable_patterns = [
            r'Apache/2\.4\.[0-9]{1,2}(?!.[0-9])',  # Apache 2.4.0-2.4.49
            r'OpenSSL/1\.0\.[0-9]',  # OpenSSL 1.0.x
            r'Python/3\.8\.[0-9]',  # Python 3.8.x
        ]
        
        for pattern in vulnerable_patterns:
            if re.search(pattern, software_version):
                return True
        
        return False
    
    def _calculate_severity(self, cvss_score: float) -> str:
        """Calculate severity based on CVSS score"""
        if cvss_score >= 9.0:
            return 'CRITICAL'
        elif cvss_score >= 7.0:
            return 'HIGH'
        elif cvss_score >= 4.0:
            return 'MEDIUM'
        else:
            return 'LOW'
    
    def _calculate_risk_score(self, vulnerabilities: List[Dict]) -> float:
        """Calculate overall asset risk score (0.0-1.0)"""
        if not vulnerabilities:
            return 0.0
        
        total_cvss = sum(v['cvss_score'] for v in vulnerabilities)
        max_possible = 10.0 * len(vulnerabilities)
        
        return min(total_cvss / max_possible, 1.0)
    
    def scan_network(self, assets: List[Dict]) -> Dict[str, Any]:
        """Perform network-wide vulnerability scan"""
        scan_results = {
            'scan_timestamp': datetime.now().isoformat(),
            'total_assets': len(assets),
            'assets_scanned': 0,
            'assets_with_vulnerabilities': 0,
            'total_vulnerabilities': 0,
            'critical_vulns': 0,
            'high_vulns': 0,
            'scan_details': []
        }
        
        for asset in assets:
            result = self.scan_asset(asset)
            scan_results['assets_scanned'] += 1
            
            if result['vulnerabilities_found']:
                scan_results['assets_with_vulnerabilities'] += 1
                scan_results['total_vulnerabilities'] += len(result['vulnerabilities_found'])
                
                for vuln in result['vulnerabilities_found']:
                    if vuln['severity'] == 'CRITICAL':
                        scan_results['critical_vulns'] += 1
                    elif vuln['severity'] == 'HIGH':
                        scan_results['high_vulns'] += 1
            
            scan_results['scan_details'].append(result)
        
        return scan_results
    
    def generate_patch_recommendations(self, vulnerabilities: List[Dict]) -> List[Dict]:
        """Generate patch and remediation recommendations"""
        recommendations = []
        
        for vuln in vulnerabilities:
            rec = {
                'cve_id': vuln['cve_id'],
                'vulnerability': vuln['description'],
                'recommendation': self._get_patch_recommendation(vuln['cve_id']),
                'urgency': 'IMMEDIATE' if vuln['severity'] == 'CRITICAL' else 'URGENT' if vuln['severity'] == 'HIGH' else 'STANDARD',
                'estimated_fix_time_hours': 4 if vuln['severity'] == 'CRITICAL' else 8
            }
            recommendations.append(rec)
        
        return recommendations
    
    def _get_patch_recommendation(self, cve_id: str) -> str:
        """Get patch recommendation for CVE"""
        patch_map = {
            'CVE-2024-1234': 'Upgrade Web Framework to latest version',
            'CVE-2024-5678': 'Update database driver to v2.5.0+',
            'CVE-2024-9101': 'Apply security patch for UI module',
            'CVE-2024-1121': 'Reconfigure API Gateway authentication'
        }
        return patch_map.get(cve_id, 'Review vendor security advisory')
    
    def get_vulnerability_report(self) -> Dict[str, Any]:
        """Generate comprehensive vulnerability report"""
        return {
            'report_timestamp': datetime.now().isoformat(),
            'assets_scanned': len(self.scanned_assets),
            'total_vulnerabilities_found': len(self.found_vulnerabilities),
            'vulnerabilities_by_severity': self._group_by_severity(),
            'avg_risk_score': self._calculate_average_risk(),
            'vulnerable_assets': [a['id'] for a in self.scanned_assets]
        }
    
    def _group_by_severity(self) -> Dict[str, int]:
        """Group vulnerabilities by severity"""
        severities = {'CRITICAL': 0, 'HIGH': 0, 'MEDIUM': 0, 'LOW': 0}
        for vuln in self.found_vulnerabilities:
            severity = vuln.get('severity', 'LOW')
            severities[severity] = severities.get(severity, 0) + 1
        return severities
    
    def _calculate_average_risk(self) -> float:
        """Calculate average risk across all assets"""
        if not self.scanned_assets:
            return 0.0
        # Placeholder - would calculate actual average in production
        return sum(0.3 for _ in self.scanned_assets) / len(self.scanned_assets)
